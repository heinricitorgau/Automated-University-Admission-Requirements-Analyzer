# University Ranking Crawler - 開發與架構日誌

## 1. 程式架構說明 (Refactored v2.0)

本專案已於 2026/02/17 完成模組化重構，採用分層架構以提升可維護性。

### 目錄結構
```
clawer/
├── clawer_main.py         # 🚀 程式入口 (Entry Point)
├── constants/             # 📚 常量定義 (Data Layer)
│   ├── presets.py         # 排名 ID 與 URL 預設值
│   ├── countries.py       # 國家代碼與名稱對照
│   └── regions.py         # 地區分組定義
├── ui/                    # 🖥️ 使用者介面 (Presentation Layer)
│   ├── cli.py             # 命令行參數解析
│   ├── interactive.py     # 交互式選單邏輯
│   └── validators.py      # 輸入驗證與處理
├── utils/                 # 🛠️ 通用工具 (Utility Layer)
│   ├── logging.py         # 日誌設定
│   ├── retry.py           # 重試機制裝飾器
│   ├── formatters.py      # 數據格式化函數
│   └── cache.py           # 簡單快取實作
├── crawler.py             # 🎮 核心控制器 (Controller)
├── fetcher.py             # 🌐 網路傳輸 (Network Layer)
├── extractor.py           # 🔍 資料解析 (Parsing Layer)
├── exporter.py            # 💾 資料輸出 (Output Layer)
├── config.py              # ⚙️ 配置管理 (Configuration)
└── models.py              # 📦 資料模型 (Model)
```

### 核心模組職責
*   **clawer_main.py**: 極簡化的入口，負責判斷啟動 CLI 或交互模式。
*   **crawler.py**: 總指揮 (Orchestrator)。負責初始化 Config，協調 Fetcher 下載、Extractor 解析，最後交由 Exporter 輸出。
*   **fetcher.py**: 負責所有 HTTP 請求，處理 Headers、Cookies、SSL 驗證與錯誤重試。
*   **extractor.py**: 從 HTML/JSON 中提取結構化資料 (如 GPA, IELTS 等要求)。
*   **exporter.py**: 支援 Console, CSV, Excel, JSON 多種輸出格式。
*   **config.py**: 集中管理所有設定 (Timeout, Limits, Async toggle 等)。

---

## 2. Note (舊版架構參考)
*(此區塊保留作為歷史參考，描述重構前的單一檔案結構)*
*   ~~clawer1_updated_patched.py~~: (已棄用) 舊版入口。
*   ~~utils.py~~: (舊版) 混合了所有工具函數，現已拆分。

---

## 3. Diary (開發日誌)

### 2/17/2026 (New)
**第五階段：模組化重構 (Modularization Refactoring)**

**目標**
改善程式碼可讀性與可維護性，將龐大的 `clawer_main.py` 與 `utils.py` 拆解。

**執行項目**
1.  **架構分層**：建立 `ui`, `constants`, `utils` 三個新套件包。
2.  **職責分離**：
    *   將寫死在程式碼中的 `SUBJECT_PRESETS`, `COUNTRY_CODES` 移至 `constants/`。
    *   將命令行解析與交互式選單邏輯從主程式移至 `ui/`。
    *   將日誌、重試、格式化工具拆分至 `utils/` 子模組。
3.  **代碼瘦身**：
    *   `clawer_main.py` 從 516 行減少至 28 行 (-94%)。
    *   `utils.py` 轉為兼容層 (Re-export)，確保向後兼容。
4.  **相容性測試**：
    *   建立 `test_imports.py` 驗證所有模組引用正常。
    *   確認 CLI 與 Interactive 模式功能均無回歸 (Regression)。

### 2/15/2026
**第四階段：brotli 解碼錯誤**
*   **錯誤**: `Received response with content-encoding: br, but failed to decode it`
*   **原因**: aiohttp 與 brotli 版本衝突。
*   **解法**: 在 Headers 限制 `Accept-Encoding: gzip, deflate`，不接受 br 壓縮。

### 2/15/2026
**第三階段：TimeoutError (Async 模式)**
*   **問題**: `asyncio.TimeoutError` 發生在大量 detail page 抓取時。
*   **解法**: 實作 Retry 機制，雖然仍有風險但已能完成大部分任務。

### 2/15/2026
**第二階段：SSL 驗證失敗**
*   **問題**: macOS venv 環境無 root cert，導致 `SSLCertVerificationError`。
*   **解法**: 引入 `certifi` 並在 TCPConnector 中指定 SSL context。

### 2/15/2026
**第一階段：API 404 問題**
*   **問題**: QS API 改版導致部分 ranking_id 失效 (404)。
*   **解法**: 改為由 ranking_page_url 進入，動態解析頁面上的 nid，再進行 API 查詢。

---

## 4. 系統穩定度評估 (v2.0)

| 模式 | 穩定度 | 備註 |
| :--- | :--- | :--- |
| **World Ranking** | ⭐ 高 | API 穩定，資料完整 |
| **Subject Ranking** | 🌗 中 | 偶發 Timeout，視子學科資料量而定 |
| **National Ranking** | 🌗 中 | 當該國大學數量極多時 (如 US)，Detail page 抓取耗時較長 |
| **Async 模式** | ⚠️ 中低 | 需嚴格控制並發量，否則易觸發 Rate Limit |

## 5. 未來升級方向
*   **穩定性**: 引入 `Semaphore` 限制 Async 並發數；實作 Exponential Backoff。
*   **資料工程**: 引入 SQLite 快取結果，減少重複請求。
*   **AI 應用**: 建立錄取難度預測模型 (基於 GPA/IELTS 要求)。
