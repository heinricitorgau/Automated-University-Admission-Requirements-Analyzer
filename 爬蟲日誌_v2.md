# University Ranking Crawler - 開發與架構日誌

## 1. 程式架構說明 (Refactored v2.0)

本專案已於 2026/02/17 完成模組化重構，採用分層架構以提升可維護性。

### 目錄結構
```
clawer/
├── clawer_main.py         # 🚀 程式入口 (Entry Point)
├── constants/             # 📚 常量定義 (Data Layer)
│   ├── presets.py         # 排名 ID 與 URL 預設值
│   ├── countries.py       # 國家代碼與名稱對照
│   └── regions.py         # 地區分組定義
├── ui/                    # 🖥️ 使用者介面 (Presentation Layer)
│   ├── cli.py             # 命令行參數解析
│   ├── interactive.py     # 交互式選單邏輯
│   └── validators.py      # 輸入驗證與處理
├── utils/                 # 🛠️ 通用工具 (Utility Layer)
│   ├── logging.py         # 日誌設定
│   ├── retry.py           # 重試機制裝飾器
│   ├── formatters.py      # 數據格式化函數
│   └── cache.py           # 簡單快取實作
├── crawler.py             # 🎮 核心控制器 (Controller)
├── fetcher.py             # 🌐 網路傳輸 (Network Layer)
├── extractor.py           # 🔍 資料解析 (Parsing Layer)
├── exporter.py            # 💾 資料輸出 (Output Layer)
├── config.py              # ⚙️ 配置管理 (Configuration)
└── models.py              # 📦 資料模型 (Model)
```

### 核心模組職責
*   **clawer_main.py**: 極簡化的入口，負責判斷啟動 CLI 或交互模式。
*   **crawler.py**: 總指揮 (Orchestrator)。負責初始化 Config，協調 Fetcher 下載、Extractor 解析，最後交由 Exporter 輸出。
*   **fetcher.py**: 負責所有 HTTP 請求，處理 Headers、Cookies、SSL 驗證與錯誤重試。
*   **extractor.py**: 從 HTML/JSON 中提取結構化資料 (如 GPA, IELTS 等要求)。
*   **exporter.py**: 支援 Console, CSV, Excel, JSON 多種輸出格式。
*   **config.py**: 集中管理所有設定 (Timeout, Limits, Async toggle 等)。

---

## 2. Note (舊版架構參考)
*(此區塊保留作為歷史參考，描述重構前的單一檔案結構)*
*   ~~clawer1_updated_patched.py~~: (已棄用) 舊版入口。
*   ~~utils.py~~: (舊版) 混合了所有工具函數，現已拆分。

---

## 3. Diary (開發日誌)

### 2/19/2026 (Performance Boost)
**極速化與 async 預設**

**目標**
全面提升抓取速度，讓大規模資料收集更有效率。

**執行項目**
1.  將 `Config` 預設 `use_async=True`，全面啟用 async 並發抓取。
2.  將 `max_concurrent_requests` 預設提升至 32，`request_delay` 降至 0.01 秒。
3.  README 增加效能調校建議，指引如何依網路/目標伺服器狀況調整參數。
4.  經測試 async 模式下抓取速度大幅提升，功能與穩定性維持。
5.  若遇 rate limit，可適度調整參數以兼顧穩定。

### 2/17/2026 
**模組化重構 (Modularization Refactoring)**

**目標**
改善程式碼可讀性與可維護性，將龐大的 `clawer_main.py` 與 `utils.py` 拆解。

**執行項目**
1.  **架構分層**：建立 `ui`, `constants`, `utils` 三個新套件包。
2.  **職責分離**：
    *   將寫死在程式碼中的 `SUBJECT_PRESETS`, `COUNTRY_CODES` 移至 `constants/`。
    *   將命令行解析與交互式選單邏輯從主程式移至 `ui/`。
    *   將日誌、重試、格式化工具拆分至 `utils/` 子模組。
3.  **代碼瘦身**：
    *   `clawer_main.py` 從 516 行減少至 28 行 (-94%)。
    *   `utils.py` 轉為兼容層 (Re-export)，確保向後兼容。
4.  **相容性測試**：
    *   建立 `test_imports.py` 驗證所有模組引用正常。
    *   確認 CLI 與 Interactive 模式功能均無回歸 (Regression)。

### 2/15/2026
**brotli 解碼錯誤**
*   **錯誤**: `Received response with content-encoding: br, but failed to decode it`
*   **原因**: aiohttp 與 brotli 版本衝突。
*   **解法**: 在 Headers 限制 `Accept-Encoding: gzip, deflate`，不接受 br 壓縮。
**TimeoutError (Async 模式)**
*   **問題**: `asyncio.TimeoutError` 發生在大量 detail page 抓取時。
*   **解法**: 實作 Retry 機制，雖然仍有風險但已能完成大部分任務。
**SSL 驗證失敗**
*   **問題**: macOS venv 環境無 root cert，導致 `SSLCertVerificationError`。
*   **解法**: 引入 `certifi` 並在 TCPConnector 中指定 SSL context。
**API 404 問題**
*   **問題**: QS API 改版導致部分 ranking_id 失效 (404)。
*   **解法**: 改為由 ranking_page_url 進入，動態解析頁面上的 nid，再進行 API 查詢。

### 2/14/2026 (Code Cleanup & UI Refinements)
**代碼清理與介面優化**
**目標**
提升代碼整潔度並優化終端機輸出表格的閱讀體驗。

**執行項目**
1.  **代碼清理**:
    *   移除 `clawer` 目錄下所有 Python 檔案 (`clawer_main.py`, `crawler.py`, `config.py`, `models.py`, `utils.py`, `fetcher.py`, `extractor.py`, `exporter.py`) 的 Docstrings 與註解，保持程式碼精簡。
2.  **輸出表格優化**:
    *   `exporter.py`: 移除 Console 輸出的水平與垂直分隔線，改以空白分隔，提升視覺清爽度。
    *   **欄位調整**: 更新 Main Table 的顯示欄位，對齊 QS World University Rankings 官方指標 (Overall, Academic Reputation, Employer Reputation 等)，並移除入學門檻分數 (GMAT, GRE 等)，將其保留於 Secondary Metric Ranking。
    *   **智慧隱藏**: 實作欄位自動隱藏功能，若某指標在當前所有搜尋結果中皆為 N/A，則自動不顯示該欄位。
3.  **檔案整理**:
    *   移除過時檔案 `clawer1.py`, `backup.py.txt`。
    *   重新命名 `1requirements.txt` 為 `requirements.txt`。


### 2/14/2026
**Subject Ranking 修復與穩定性優化**

**目標**
解決學科排名抓取時的資料不全與逾時問題。

**執行項目**
1.  **修正分頁邏輯**：
    *   `crawler.py`: 修正分頁終止條件。原本依據「頁面資料 < 100」判斷，導致資料量少於 100 筆的學科（如 Music, 20筆）被誤判為資料抓取不全。改為檢查回傳是否為空。
2.  **錯誤回報優化**：
    *   `clawer_main.py`: 引入 `traceback` 模組，完整印出被 catch 住的 Exception，解決錯誤訊息被吞沒的問題。
    *   `fetcher.py`: 加入 Debug logging，記錄 API 請求失敗細節。
3.  **Timeout 與穩定性調整**：
    *   發現大量並發抓取 Detail Page 時容易觸發 `asyncio.TimeoutError`。
    *   `config.py`: 將預設 timeout 由 10s 提升至 30s。
    *   `clawer_main.py`: 針對 Subject Ranking，暫時將預設模式切換回同步 (`use_async=False`) 以確保穩定性，犧牲速度換取成功率。

### 2/13/2026
**Ranking Logic Refactoring (Overall Ranking Optional Mode)**

**目標**
優化排名邏輯流程，使第二順位的 Overall Ranking 預設不自動執行，改為在第一順位完成後詢問使用者是否需要進行第二順位排名。

**背景說明**
舊版邏輯中，若設定包含 Overall Ranking，系統會自動執行兩次排名流程，導致：
	•	執行時間增加
	•	不必要的 API 請求
	•	使用者無法中途選擇停止第二順位分析

因此決定改為「互動式選擇機制」。

**執行項目**
	1.	**重構 Ranking Flow**
	•	修改 clawer1_updated_patched.py
	•	將第二順位 (Overall Ranking) 預設關閉
	•	第一順位完成後再提示使用者是否執行第二順位
	2.	**新增互動提示流程**
    First ranking completed.
    Do you want to perform Overall Ranking as secondary ranking? (y/n):
    •	若使用者輸入 y → 進行第二順位
	•	若輸入 n → 直接結束流程
	3.	**Exporter 邏輯調整**
	•	將 Overall Ranking 移至 conditional execution
	•	避免在 Config 初始化時強制載入
	4.	**流程優化成果**
	•	減少不必要的 API 呼叫
	•	提升使用者操作彈性
	•	縮短單次任務執行時間
	•	結構更加清晰，符合「主排序 → 可選次排序」架構

**架構層面意義**
此次調整將排名流程改為：
Primary Ranking
        ↓
Interactive Prompt
        ↓
(Optional) Secondary Overall Ranking
使 Ranking System 更貼近真實決策流程，而非固定雙排序架構。

### 2/12/2026
**Default Ranking Behavior Adjustment (World TOP 100 as Default)**

**目標**
調整系統預設行為，使程式在未指定國家條件時，預設抓取「世界前 100 名 (World TOP 100)」排名；若需要各國排名，則必須額外加入國家條件參數。

**背景說明**
舊版預設會自動套用特定國家 (如 US) 作為預設篩選條件，導致：
	•	使用者未指定條件時僅取得單一國家資料
	•	不符合一般使用者對「QS 排名」的直覺期待
	•	邏輯上世界排名與國家排名界線不夠明確

因此重新定義預設行為為「World Ranking TOP 100」。

**執行項目**
1.  **Config 預設值修改**
	•	將 `country` 預設值由 `"us"` 改為 `None`
	•	明確區分「世界排名」與「國家排名」兩種模式

2.  **Crawler 邏輯調整**
	•	若 `country is None` → 執行 World Ranking
	•	若指定 `country` → 啟用 National Ranking 過濾條件

3.  **CLI 行為更新**
	•	未輸入國家參數時 → 預設抓取 World TOP 100
	•	若需各國排名 → 需額外加入國家代碼條件

4.  **架構層面優化**
	•	強化 Ranking 模式分離
	•	避免隱性條件干擾預設流程
	•	讓系統邏輯更符合直覺：「世界為主、國家為選項」

**調整後邏輯結構**

World TOP 100 (Default)
        ↓
(Optional) Country Filter Applied
        ↓
National Ranking Mode

此變更屬於預設行為重構 (Default Behavior Refactoring)，並未影響既有功能，但提升了系統一致性與可預期性。

### 2/11/2026
**Implementing Country in Overall Ranking Table**

**目標**
在 Overall Ranking（次順位排名）與主排名表格中加入「Country」欄位，確保世界排名模式下各校所屬國家資訊清楚呈現。

**背景說明**
在預設改為 World TOP 100 後，排名結果涵蓋多國大學，但 Console 表格與部分匯出格式未明確顯示國家欄位，導致：

	•	世界排名情境下資訊辨識度不足  
	•	主排名與次順位 Overall Ranking 表格格式不一致  
	•	CSV / Excel / JSON 匯出缺少完整國家資訊  

因此決定統一在所有輸出層加入 Country 欄位。

**執行項目**
1.  **修改 `exporter.py`**
	•	在 Main Ranking Table 加入 `Country` 欄位  
	•	在 Secondary Overall Ranking Table 加入 `Country` 欄位  
	•	確保欄位排序一致且版面對齊  

2.  **同步更新所有輸出格式**
	•	Console Output  
	•	CSV Export  
	•	Excel Export  
	•	JSON Export  

3.  **驗證流程**
	•	執行 limited crawl 測試 World TOP 100 輸出  
	•	建立 mock 測試腳本快速驗證表格排版  
	•	確認主表與次表 Country 欄位正確顯示  

**調整後輸出結構（示意）**

Rank | University | Country | Overall Score | ...
-----------------------------------------------------

此變更屬於輸出層一致性優化 (Output Layer Consistency Improvement)，提升資料完整性與專案專業度，並為後續多國比較分析打下基礎。

---

## 4. 系統穩定度評估 (v2.0)

| 模式 | 穩定度 | 備註 |
| :--- | :--- | :--- |
| **World Ranking** | ⭐ 高 | API 穩定，資料完整 |
| **Subject Ranking** | 🌗 中 | 偶發 Timeout，視子學科資料量而定 |
| **National Ranking** | 🌗 中 | 當該國大學數量極多時 (如 US)，Detail page 抓取耗時較長 |
| **Async 模式** | ⚠️ 中低 | 需嚴格控制並發量，否則易觸發 Rate Limit |

## 5. 未來升級方向
*   **穩定性**: 引入 `Semaphore` 限制 Async 並發數；實作 Exponential Backoff。
*   **資料工程**: 引入 SQLite 快取結果，減少重複請求。
*   **AI 應用**: 建立錄取難度預測模型 (基於 GPA/IELTS 要求)。
